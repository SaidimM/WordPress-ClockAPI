# HTTP redirect to HTTPS
  server {
      listen 80;
      server_name saidim.com www.saidim.com;

      # Let's Encrypt verification path
      location /.well-known/acme-challenge/ {
          root /var/www/html;
      }

      # Redirect all other requests to HTTPS
      location / {
          return 301 https://$server_name$request_uri;
      }
  }

  # HTTPS server
  server {
      listen 443 ssl;
      http2 on;
      server_name saidim.com www.saidim.com;

      # SSL configuration (using cert-updater managed certificates)
      ssl_certificate /etc/ssl/certs/fullchain.pem;
      ssl_certificate_key /etc/ssl/certs/privkey.pem;

      # SSL optimization
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_prefer_server_ciphers on;
      ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
      ssl_session_cache shared:SSL:10m;
      ssl_session_timeout 10m;

      # Security headers
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      add_header X-Frame-Options SAMEORIGIN always;
      add_header X-Content-Type-Options nosniff always;
      add_header X-XSS-Protection "1; mode=block" always;

      # File upload size limit
      client_max_body_size 100M;

      # Serve cached images statically from Clock API data directory
      location /cache/images/ {
          alias /var/cache/clock-api/images/;
          expires 7d;
          add_header Cache-Control "public, immutable";
          add_header Access-Control-Allow-Origin * always;
          access_log off;
      }

      # Clock API proxy
      location /api/clock/ {
          proxy_pass http://wordpress-clock-api:3000/api/v1/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Platform $http_x_platform;

          # CORS headers
          add_header Access-Control-Allow-Origin * always;
          add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
          add_header Access-Control-Allow-Headers "Content-Type, X-API-Key, X-Platform" always;

          # Handle OPTIONS requests
          if ($request_method = OPTIONS) {
              return 204;
          }
      }

      # Proxy to WordPress container
      location / {
          proxy_pass http://wordpress-app:80;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
      }


      # Security: Deny access to sensitive files
      location ~ /\. {
          deny all;
      }

      location ~* /(?:uploads|files)/.*\.php$ {
          deny all;
      }

      location ~ ^/(wp-config\.php|readme\.html|license\.txt) {
          deny all;
      }
  }